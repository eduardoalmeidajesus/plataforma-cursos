<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Cursos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script defer>
    const API_CURSOS = 'http://localhost:8000/api/cursos';
    const API_CATEGORIAS = 'http://localhost:8000/api/categorias';
    const API_PROFESSORES = 'http://localhost:8000/api/professores';

    async function carregarCursos() {
      const res = await fetch(API_CURSOS);
      const cursos = await res.json();
      const tbody = document.getElementById('listaCursos');
      tbody.innerHTML = '';
      
      cursos.forEach(curso => {
        // Verifica se os relacionamentos existem e acessa corretamente
        const professorNome = curso.professor ? curso.professor.nome : '-';
        const categoriaNome = curso.categoria ? curso.categoria.nome : '-';
        
        tbody.innerHTML += `
          <tr>
            <td>${curso.titulo}</td>
            <td>${professorNome}</td>
            <td>${categoriaNome}</td>
            <td>R$ ${parseFloat(curso.preco).toFixed(2)}</td>
            <td>
              <button class="btn btn-sm btn-primary" onclick="editar(${curso.id}, '${curso.titulo}', '${curso.descricao}', ${curso.preco}, ${curso.professor_id || 'null'}, ${curso.categoria_id || 'null'})">Editar</button>
              <button class="btn btn-sm btn-danger" onclick="excluir(${curso.id})">Excluir</button>
            </td>
          </tr>`;
      });
    }

    async function carregarSelects() {
      const catSelect = document.getElementById('categoria_id');
      const profSelect = document.getElementById('professor_id');

      const [resCat, resProf] = await Promise.all([
        fetch(API_CATEGORIAS),
        fetch(API_PROFESSORES)
      ]);

      const categorias = await resCat.json();
      const professores = await resProf.json();

      catSelect.innerHTML = '<option value="">-- Selecione --</option>';
      categorias.forEach(c => {
        catSelect.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
      });

      profSelect.innerHTML = '<option value="">-- Selecione --</option>';
      professores.forEach(p => {
        profSelect.innerHTML += `<option value="${p.id}">${p.nome}</option>`;
      });
    }

    async function salvarCurso(e) {
      e.preventDefault();
      const id = document.getElementById('cursoId').value;
      const titulo = document.getElementById('titulo').value;
      const descricao = document.getElementById('descricao').value;
      const preco = document.getElementById('preco').value;
      const professor_id = document.getElementById('professor_id').value;
      const categoria_id = document.getElementById('categoria_id').value;

      const dados = { titulo, descricao, preco, professor_id, categoria_id };

      const url = id ? `${API_CURSOS}/${id}` : API_CURSOS;
      const metodo = id ? 'PUT' : 'POST';

      await fetch(url, {
        method: metodo,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(dados)
      });

      document.getElementById('formCurso').reset();
      document.getElementById('cursoId').value = '';
      carregarCursos();
    }

    function editar(id, titulo, descricao, preco, professor_id, categoria_id) {
      document.getElementById('cursoId').value = id;
      document.getElementById('titulo').value = titulo;
      document.getElementById('descricao').value = descricao;
      document.getElementById('preco').value = preco;
      document.getElementById('professor_id').value = professor_id;
      document.getElementById('categoria_id').value = categoria_id;
    }

    async function excluir(id) {
      if (confirm('Excluir curso?')) {
        await fetch(`${API_CURSOS}/${id}`, { method: 'DELETE' });
        carregarCursos();
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      carregarCursos();
      carregarSelects();
    });
  </script>
</head>
<body class="bg-light">
  <div class="container mt-3">
    <a href="index.html" class="btn btn-secondary mb-3">
        <i class="bi bi-arrow-left"></i> Voltar
    </a>
  </div>
  <div class="container mt-5">
    <h1>Cursos</h1>

    <form id="formCurso" onsubmit="salvarCurso(event)" class="mb-4">
      <input type="hidden" id="cursoId" />
      <div class="mb-3">
        <label for="titulo" class="form-label">Título</label>
        <input type="text" id="titulo" class="form-control" required />
      </div>
      <div class="mb-3">
        <label for="descricao" class="form-label">Descrição</label>
        <textarea id="descricao" class="form-control" required></textarea>
      </div>
      <div class="mb-3">
        <label for="preco" class="form-label">Preço (R$)</label>
        <input type="number" id="preco" class="form-control" step="0.01" required />
      </div>
      <div class="mb-3">
        <label for="categoria_id" class="form-label">Categoria</label>
        <select id="categoria_id" class="form-select" required></select>
      </div>
      <div class="mb-3">
        <label for="professor_id" class="form-label">Professor</label>
        <select id="professor_id" class="form-select" required></select>
      </div>
      <button class="btn btn-success">Salvar</button>
    </form>

    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Título</th>
          <th>Professor</th>
          <th>Categoria</th>
          <th>Preço</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="listaCursos"></tbody>
    </table>
  </div>
</body>
</html>